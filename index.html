<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeakRadar ‚Äî GLOBAL Analytics</title>
  <style>
    :root{
      --bg:#070a14;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.035);
      --line:rgba(255,255,255,.10);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.64);
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 70% -10%, rgba(0,255,255,.12), transparent 60%),
        radial-gradient(900px 700px at -10% 20%, rgba(255,0,255,.10), transparent 60%),
        radial-gradient(900px 700px at 60% 120%, rgba(0,255,120,.08), transparent 60%),
        var(--bg);
    }
    a{color:inherit}
    .wrap{max-width:1280px;margin:0 auto;padding:18px 14px 28px}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{
      display:flex;gap:10px;align-items:center;
      padding:12px 14px;border:1px solid var(--line);
      border-radius:999px;background:var(--card);box-shadow:var(--shadow)
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:linear-gradient(135deg, rgba(0,255,255,1), rgba(255,0,255,1));
      box-shadow:0 0 18px rgba(0,255,255,.35)
    }
    .brand h1{font-size:14px;margin:0;letter-spacing:.6px}
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, var(--card), var(--card2));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px
    }
    .card h2{font-size:13px;margin:0 0 10px 0;color:rgba(255,255,255,.86);letter-spacing:.4px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      padding:11px 12px;
      outline:none
    }
    textarea{min-height:118px;resize:vertical}
    button{
      cursor:pointer;
      background:linear-gradient(135deg, rgba(0,255,255,.16), rgba(255,0,255,.14));
      border:1px solid rgba(255,255,255,.20);
      font-weight:900;
      letter-spacing:.2px;
    }
    button:hover{filter:brightness(1.07)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btns button{flex:1 1 160px}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
    @media(max-width:760px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
    .kpi b{display:block;font-size:16px}
    .kpi span{display:block;color:var(--muted);font-size:12px;margin-top:4px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:760px){.split{grid-template-columns:1fr}}
    .list{border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
    .row{
      display:flex;justify-content:space-between;gap:10px;
      padding:10px 12px;border-top:1px solid rgba(255,255,255,.10);
      font-size:13px;
    }
    .row:first-child{border-top:none}
    .row .left{min-width:0;flex:1}
    .row .right{flex:0 0 auto;text-align:right;white-space:nowrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;font-weight:900;letter-spacing:.2px
    }
    .crit{background:rgba(255,0,80,.14)}
    .high{background:rgba(255,160,0,.14)}
    .med{background:rgba(255,255,255,.10)}
    .ok{background:rgba(0,255,160,.10)}
    .toast{
      position:fixed;left:12px;right:12px;bottom:14px;max-width:1280px;margin:0 auto;
      padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.45);display:none
    }
    .mini{font-size:12px;color:var(--muted);line-height:1.6;margin:0}
    pre{margin:0;white-space:pre-wrap}
    table{
      width:100%;border-collapse:collapse;overflow:hidden;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18)
    }
    th,td{padding:10px 10px;border-top:1px solid rgba(255,255,255,.10);font-size:13px;vertical-align:top}
    th{color:rgba(255,255,255,.82);text-align:left;font-size:12px;letter-spacing:.3px}
    tr:first-child th{border-top:none}
    .nowrap{white-space:nowrap}
    .clip{
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden
    }
    .searchRow{display:grid;grid-template-columns:1.1fr .9fr .8fr;gap:10px}
    @media(max-width:760px){.searchRow{grid-template-columns:1fr}}
    .hint{margin-top:10px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <h1>LeakRadar ‚Äî GLOBAL Analytics</h1>
        <small>All chats/users ‚Ä¢ Trends ‚Ä¢ Top targets ‚Ä¢ Top leaks ‚Ä¢ Live feed</small>
      </div>
    </div>
    <div class="muted" id="clock">‚Äî</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>Qu√©t nhanh (GLOBAL)</h2>

      <label>Nh·∫≠p IP / Domain (m·ªói d√≤ng 1 target)</label>
      <textarea id="targets" placeholder="113.173.124.140&#10;example.com"></textarea>

      <div class="btns">
        <button id="btnScan">üöÄ Scan ngay</button>
        <button id="btnRefresh">üîÑ Refresh</button>
        <button id="btnExport">‚¨áÔ∏è Export CSV (GLOBAL)</button>
      </div>

      <p class="mini hint">
        ‚Ä¢ Dashboard n√†y hi·ªÉn th·ªã <b>to√†n b·ªô</b> scan/bulk t·ª´ Telegram (DM + group).<br/>
        ‚Ä¢ Scan ngay s·∫Ω trigger <span class="mono">/bulk</span> qua endpoint <span class="mono">/telegram</span> (MVP).<br/>
        ‚Ä¢ Mu·ªën s·∫°ch h∆°n: t√°ch endpoint <span class="mono">/api/scan</span> ri√™ng (m√¨nh c√≥ th·ªÉ refactor ti·∫øp).
      </p>

      <p class="mini" id="status">‚Äî</p>

      <div class="kpis">
        <div class="kpi"><b id="kTotal">‚Äî</b><span>Total scans</span></div>
        <div class="kpi"><b id="kCrit">‚Äî</b><span>Critical</span></div>
        <div class="kpi"><b id="kHigh">‚Äî</b><span>High</span></div>
        <div class="kpi"><b id="kMed">‚Äî</b><span>Medium</span></div>
        <div class="kpi"><b id="kOk">‚Äî</b><span>OK</span></div>
      </div>

      <div class="split">
        <div>
          <h2 style="margin-top:12px">Top targets</h2>
          <div class="list" id="topTargets"></div>
        </div>
        <div>
          <h2 style="margin-top:12px">Top leak paths</h2>
          <div class="list" id="topLeaks"></div>
        </div>
      </div>

      <h2 style="margin-top:12px">Xu h∆∞·ªõng 30 ng√†y (scans / critical)</h2>
      <div class="list" id="trend"></div>

      <h2 style="margin-top:12px">Live Results Feed (m·ªõi nh·∫•t)</h2>
      <div class="searchRow">
        <div>
          <label>T√¨m theo domain / IP / user / chat</label>
          <input id="q" placeholder="vd: example.com ho·∫∑c @username ho·∫∑c group name" />
        </div>
        <div>
          <label>L·ªçc Risk</label>
          <select id="risk">
            <option value="">T·∫•t c·∫£</option>
            <option value="CRITICAL">CRITICAL</option>
            <option value="HIGH">HIGH</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="OK">OK</option>
          </select>
        </div>
        <div>
          <label>Gi·ªõi h·∫°n</label>
          <select id="limit">
            <option value="100">100</option>
            <option value="200" selected>200</option>
            <option value="300">300</option>
            <option value="500">500</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th class="nowrap">Time</th>
              <th>Target</th>
              <th class="nowrap">Risk</th>
              <th class="nowrap">IP</th>
              <th class="nowrap">Ports</th>
              <th>Leaks</th>
              <th>User/Chat</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="muted">‚Äî</td></tr>
          </tbody>
        </table>
      </div>

    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>Activity log (GLOBAL)</h2>
      <p class="mini">Ghi l·∫°i h√†nh vi: command / bulk count / result risk / leaks. D√πng ƒë·ªÉ ph√¢n t√≠ch xu h∆∞·ªõng.</p>
      <div class="list" id="activity"></div>

      <h2 style="margin-top:12px">G·ª£i √Ω ph√¢n t√≠ch</h2>
      <pre class="mini" id="insight">‚Äî</pre>

      <h2 style="margin-top:12px">S·ª©c kho·∫ª k·∫øt n·ªëi</h2>
      <div class="list" id="health"></div>
      <p class="mini">N·∫øu b·∫£ng v·∫´n tr·ªëng: Worker ch∆∞a c√≥ API <span class="mono">/api/global/*</span> ho·∫∑c token sai.</p>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  FIXED CONFIG (ADMIN SET)
 *  ========================= */
const FIXED_WORKER_URL = "https://leakradar.starlinksatellitewifi.workers.dev";
const DASHBOARD_TOKEN  = "dash_9k23jf8sk29dk";

/** MVP trigger scan: d√πng /telegram gi·∫£ update /bulk
 *  - Worker c·∫ßn CORS on /telegram
 *  - Worker s·∫Ω ch·∫°y bulk runner v√† ghi v√†o GLOBAL store
 */
const GLOBAL_CHAT_ID_FOR_TRIGGER = "-1002345678901"; // d√πng 1 chatId b·∫•t k·ª≥ ƒë·ªÉ kick runner (kh√¥ng ph·∫£i workspace n·ªØa)

/** ========================= */

const $ = (id)=>document.getElementById(id);

function nowClock(){
  $("clock").textContent = new Date().toLocaleString("vi-VN");
}
setInterval(nowClock, 800); nowClock();

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__t);
  window.__t=setTimeout(()=>t.style.display="none", 2600);
}

function esc(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function pill(r){
  const cls = r==="CRITICAL"?"crit":r==="HIGH"?"high":r==="MEDIUM"?"med":"ok";
  return `<span class="pill ${cls}">${esc(r||"OK")}</span>`;
}

function authHeaders(){
  return { "Authorization": "Bearer " + DASHBOARD_TOKEN };
}

function apiBase(){
  return FIXED_WORKER_URL.replace(/\/+$/,"");
}

async function fetchJSON(path){
  const r = await fetch(apiBase()+path, { headers: { ...authHeaders() } });
  const j = await r.json().catch(()=>({ok:false,error:"bad json"}));
  if(!r.ok) throw new Error(j.error || ("HTTP "+r.status));
  return j;
}

function toPairs(obj){
  return Object.entries(obj||{})
    .map(([k,v])=>({k, v:Number(v)||0}))
    .sort((a,b)=>b.v-a.v);
}

function renderList(el, items, fmt){
  el.innerHTML = "";
  if(!items.length){
    el.innerHTML = `<div class="row"><span class="muted">‚Äî</span><span class="muted">‚Äî</span></div>`;
    return;
  }
  for(const it of items){
    el.innerHTML += fmt(it);
  }
}

function fmtTime(ts){
  try{
    return new Date(ts||Date.now()).toLocaleString("vi-VN");
  }catch{ return "‚Äî"; }
}

function insightFromStats(s){
  if(!s) return "‚Äî";
  const total = s.totalScans || 0;
  const rc = s.riskCount || {};
  const crit = rc.CRITICAL||0, high = rc.HIGH||0, med = rc.MEDIUM||0, ok = rc.OK||0;

  const lines = [];
  lines.push(`‚Ä¢ T·ªïng scan: ${total}`);
  lines.push(`‚Ä¢ Risk mix: CRIT ${(total?Math.round(crit/total*100):0)}% | HIGH ${(total?Math.round(high/total*100):0)}% | MED ${(total?Math.round(med/total*100):0)}% | OK ${(total?Math.round(ok/total*100):0)}%`);

  const topT = toPairs(s.topTargets).slice(0,3).map(x=>x.k).join(", ");
  if(topT) lines.push(`‚Ä¢ Targets n·ªïi b·∫≠t: ${topT}`);

  const topL = toPairs(s.topLeaks).slice(0,3).map(x=>x.k).join(", ");
  if(topL) lines.push(`‚Ä¢ Leak paths n·ªïi b·∫≠t: ${topL}`);

  const last7 = (s.last30||[]).slice(0,7).reduce((a,x)=>a+(x.scans||0),0);
  lines.push(`‚Ä¢ 7 ng√†y g·∫ßn nh·∫•t: ${last7} scans`);

  lines.push("");
  lines.push("G·ª£i √Ω:");
  lines.push("‚Ä¢ ∆Øu ti√™n fix theo Top leak paths (th∆∞·ªùng l√† .env/.git/phpinfo).");
  lines.push("‚Ä¢ N·∫øu CRITICAL tƒÉng: ki·ªÉm tra public ports 2375/6379/9200/... v√† rotate secrets.");
  return lines.join("\n");
}

function passesFilter(row){
  const q = ($("q").value||"").trim().toLowerCase();
  const risk = ($("risk").value||"").trim();
  if(risk && String(row.risk||"") !== risk) return false;
  if(!q) return true;

  const domain = String(row.domain||"").toLowerCase();
  const ip = String(row.resolvedIp||"").toLowerCase();
  const user = String(row.meta?.user||"").toLowerCase();
  const chat = String(row.meta?.chat||"").toLowerCase();
  const ports = (row.shodan?.ports||[]).join(",");
  return (
    domain.includes(q) || ip.includes(q) || user.includes(q) || chat.includes(q) || ports.includes(q)
  );
}

function renderTable(results){
  const tb = $("tbody");
  tb.innerHTML = "";
  if(!results.length){
    tb.innerHTML = `<tr><td colspan="7" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
    return;
  }

  const filtered = results.filter(passesFilter);

  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="7" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu theo filter.</td></tr>`;
    return;
  }

  for(const r of filtered.slice(0, 300)){
    const ports = (r.shodan?.ports||[]).slice(0,10).join(", ");
    const leakStr = (r.leaks||[]).slice(0,3).map(x=>`${x.sev}:${x.path}`).join(" | ");
    const leakMore = (r.leaks||[]).length > 3 ? ` (+${(r.leaks||[]).length-3})` : "";
    const who = `${r.meta?.user || "‚Äî"} ‚Ä¢ ${r.meta?.chat || "‚Äî"}`;
    tb.innerHTML += `
      <tr>
        <td class="nowrap muted">${esc(fmtTime(r.meta?.at || r.ts))}</td>
        <td>
          <div class="clip"><b>${esc(r.domain||"‚Äî")}</b></div>
        </td>
        <td class="nowrap">${pill(r.risk||"OK")}</td>
        <td class="nowrap muted">${esc(r.resolvedIp||"")}</td>
        <td class="nowrap muted">${esc(ports)}</td>
        <td class="muted"><span class="clip">${esc(leakStr)}${esc(leakMore)}</span></td>
        <td class="muted"><span class="clip">${esc(who)}</span></td>
      </tr>
    `;
  }
}

async function refresh(){
  $("status").textContent = "ƒêang refresh‚Ä¶";
  try{
    const limit = parseInt($("limit").value||"200",10);
    const [statsR, actR, resR] = await Promise.all([
      fetchJSON(`/api/global/stats`),
      fetchJSON(`/api/global/activity?limit=${encodeURIComponent(limit)}`),
      fetchJSON(`/api/global/results?limit=${encodeURIComponent(limit)}`)
    ]);

    // Health
    renderList($("health"), [
      {k:"stats", v: statsR.ok ? "OK" : "ERR"},
      {k:"activity", v: actR.ok ? "OK" : "ERR"},
      {k:"results", v: resR.ok ? "OK" : "ERR"},
    ], (x)=>`<div class="row"><span class="muted">${esc(x.k)}</span><span>${esc(x.v)}</span></div>`);

    // KPIs + top lists + trend
    const s = statsR.stats || null;
    const rc = s?.riskCount || {};
    $("kTotal").textContent = s?.totalScans ?? "‚Äî";
    $("kCrit").textContent = rc.CRITICAL ?? 0;
    $("kHigh").textContent = rc.HIGH ?? 0;
    $("kMed").textContent = rc.MEDIUM ?? 0;
    $("kOk").textContent = rc.OK ?? 0;

    const tt = toPairs(s?.topTargets).slice(0,10);
    renderList($("topTargets"), tt, (x)=>`<div class="row"><span class="left">${esc(x.k)}</span><span class="right muted">${x.v}</span></div>`);

    const tl = toPairs(s?.topLeaks).slice(0,10);
    renderList($("topLeaks"), tl, (x)=>`<div class="row"><span class="left">${esc(x.k)}</span><span class="right muted">${x.v}</span></div>`);

    const tr = (s?.last30 || []).slice(0,14);
    renderList($("trend"), tr, (x)=>`<div class="row"><span class="left">${esc(x.day)}</span><span class="right muted">${x.scans} scans ‚Ä¢ ${x.critical} crit</span></div>`);

    // Activity
    const act = (actR.activity || []).slice(0, 80);
    renderList($("activity"), act, (e)=>{
      const t = fmtTime(e.ts);
      if(e.type==="cmd"){
        const extra = e.cmd==="bulk" ? `count:${e.count||0}` : `target:${e.target||""}`;
        return `<div class="row"><span class="left">${esc(t)} ‚Ä¢ cmd <b>${esc(e.cmd||"")}</b> ‚Ä¢ ${esc(extra)}</span><span class="right muted">${esc((e.user||"‚Äî")+" ‚Ä¢ "+(e.chat||"‚Äî"))}</span></div>`;
      }
      if(e.type==="result"){
        return `<div class="row"><span class="left">${esc(t)} ‚Ä¢ result ‚Ä¢ ${esc(e.domain||"")}</span><span class="right">${pill(e.risk||"OK")} <span class="muted">leaks:${Number(e.leaks||0)}</span></span></div>`;
      }
      return `<div class="row"><span class="left">${esc(t)} ‚Ä¢ ${esc(e.type||"evt")}</span><span class="right muted">‚Äî</span></div>`;
    });

    // Results table
    window.__results = (resR.results || []);
    renderTable(window.__results);

    // Insight
    $("insight").textContent = insightFromStats(s);

    $("status").textContent = `OK ‚Ä¢ global results: ${window.__results.length} ‚Ä¢ refreshed ${new Date().toLocaleTimeString("vi-VN")}`;
    toast("ƒê√£ refresh.");
  }catch(e){
    $("status").textContent = "L·ªói refresh: " + (e.message||e);
    toast("L·ªói: " + (e.message||e));
  }
}

async function triggerBulk(targets){
  // MVP: gi·∫£ Telegram update ƒë·ªÉ g·ªçi /bulk
  const payload = {
    message: {
      chat: { id: GLOBAL_CHAT_ID_FOR_TRIGGER },
      text: "/bulk\n" + targets.join("\n"),
      from: { username: "dashboard" }
    }
  };
  const r = await fetch(apiBase()+"/telegram",{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error("POST /telegram failed: HTTP " + r.status);
}

async function runScan(){
  const list = $("targets").value.split(/[\n,]+/).map(x => x.trim()).filter(Boolean);
  if(!list.length) return toast("Nh·∫≠p IP/domain tr∆∞·ªõc.");
  try{
    $("status").textContent = "ƒêang g·ª≠i scan‚Ä¶";
    await triggerBulk(list.slice(0,200));
    toast("ƒê√£ g·ª≠i scan. ƒê·ª£i 5‚Äì20s r·ªìi Refresh.");
  }catch(e){
    toast("Scan l·ªói: " + (e.message||e));
    $("status").textContent = "Scan l·ªói: " + (e.message||e);
  }
}

async function exportCSV(){
  try{
    const href = apiBase() + `/api/global/export.csv`;
    const r = await fetch(href, { headers: { ...authHeaders() } });
    if(!r.ok) throw new Error("Export l·ªói HTTP " + r.status);
    const blob = await r.blob();
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `leakradar_global_${Date.now()}.csv`;
    a.click();
    toast("ƒê√£ t·∫£i CSV.");
  }catch(e){
    toast("L·ªói export: " + (e.message||e));
  }
}

$("btnScan").addEventListener("click", runScan);
$("btnRefresh").addEventListener("click", refresh);
$("btnExport").addEventListener("click", exportCSV);

// Re-render table on filter change (no extra API calls)
$("q").addEventListener("input", ()=>{ renderTable(window.__results||[]); });
$("risk").addEventListener("change", ()=>{ renderTable(window.__results||[]); });
$("limit").addEventListener("change", ()=>{ refresh().catch(()=>{}); });

// auto refresh
refresh();
setInterval(()=> refresh().catch(()=>{}), 12000);
</script>
</body>
</html>
