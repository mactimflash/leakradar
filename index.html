<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LeakRadar ‚Äî GLOBAL SaaS Dashboard</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;
      --panel2:#0c1430;
      --text:#e8ecff;
      --muted:#a9b3e6;
      --line:rgba(255,255,255,.08);
      --good:#3ddc97;
      --warn:#ffcc66;
      --high:#ff7a59;
      --crit:#ff3b3b;
      --chip:#16214a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(83,121,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(255,90,90,.18), transparent 60%),
                  linear-gradient(180deg, #070a14, #0b1020 40%, #070a14);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 16px 48px}
    header{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:18px 18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{margin:0;font-size:16px;letter-spacing:.3px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid var(--line);
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--crit)}
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      header{position:static}
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.35px;text-transform:uppercase}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      padding:11px 12px;
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px;resize:vertical;font-family:var(--mono);font-size:12px;line-height:1.35}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight:600;
      font-size:13px;
      transition:transform .06s ease, background .12s ease;
    }
    .btn:hover{background:rgba(255,255,255,.1)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(83,121,255,.55), rgba(83,121,255,.18));
      border-color: rgba(83,121,255,.45);
    }
    .btn.danger{
      background:linear-gradient(180deg, rgba(255,59,59,.45), rgba(255,59,59,.12));
      border-color: rgba(255,59,59,.35);
    }
    .btn.small{padding:8px 10px;font-size:12px;border-radius:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:var(--mono)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      font-size:12px;padding:7px 10px;border-radius:999px;
      background:rgba(22,33,74,.75);
      border:1px solid var(--line);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .chip.active{color:var(--text);border-color:rgba(83,121,255,.6);background:rgba(83,121,255,.18)}
    .kpi{
      display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px
    }
    @media (max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .k{
      padding:12px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.16)
    }
    .k .n{font-size:20px;font-weight:800}
    .k .t{font-size:12px;color:var(--muted);margin-top:2px}
    .badge{
      font-size:12px;padding:5px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18)
    }
    .b-ok{color:var(--good)}
    .b-med{color:var(--warn)}
    .b-high{color:var(--high)}
    .b-crit{color:var(--crit)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{
      font-size:12px;color:var(--muted);font-weight:600;text-align:left;padding:0 10px
    }
    td{
      background:rgba(0,0,0,.16);
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:10px;
      font-size:12px;
      vertical-align:top;
    }
    td:first-child{border-left:1px solid var(--line);border-top-left-radius:14px;border-bottom-left-radius:14px}
    td:last-child{border-right:1px solid var(--line);border-top-right-radius:14px;border-bottom-right-radius:14px}
    .right{display:flex;justify-content:flex-end}
    .toast{
      position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,.7);border:1px solid var(--line);
      padding:10px 12px;border-radius:12px;color:var(--text);
      max-width:94vw;box-shadow:var(--shadow);display:none;
      font-size:12px
    }
    .note{font-size:12px;color:var(--muted);line-height:1.35}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{
      padding:10px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.16)
    }
    .item .top{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .item .title{font-weight:800;font-size:13px}
    .item .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .dangerText{color:var(--crit)}
    .okText{color:var(--good)}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <h1>LeakRadar ‚Äî GLOBAL SaaS</h1>
      <div class="sub">Worker + KV + Shodan ¬∑ Dashboard g·ªçi th·∫≥ng <span class="mono">/api/scan</span> & <span class="mono">/api/bulk</span></div>
    </div>
    <div class="pill" id="healthPill">
      <span class="dot bad" id="healthDot"></span>
      <span id="healthText">Disconnected</span>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>Scan (SaaS API)</h2>

      <div class="row">
        <div class="col">
          <label>Target (domain / IP / URL)</label>
          <input id="targetInput" placeholder="example.com ho·∫∑c 1.2.3.4 ho·∫∑c https://example.com" />
          <div class="muted" style="margin-top:8px">
            G·ª£i √Ω g·∫ßn ƒë√¢y: <span id="recentChips" class="chips"></span>
          </div>
        </div>
        <div class="col">
          <label>Filters (GLOBAL feed)</label>
          <div class="chips" style="margin-top:2px">
            <div class="chip active" data-risk="ALL">ALL</div>
            <div class="chip" data-risk="CRITICAL">CRITICAL</div>
            <div class="chip" data-risk="HIGH">HIGH</div>
            <div class="chip" data-risk="MEDIUM">MEDIUM</div>
            <div class="chip" data-risk="OK">OK</div>
          </div>
          <div style="margin-top:10px">
            <input id="searchInput" placeholder="Search domain / org / ASN / leak path..." />
          </div>
        </div>
      </div>

      <div class="toolbar" style="margin-top:12px">
        <button class="btn primary" id="scanBtn">üîé Scan now</button>
        <button class="btn" id="refreshGlobalBtn">‚ôªÔ∏è Refresh GLOBAL</button>
        <button class="btn small" id="exportGlobalBtn">‚¨áÔ∏è Export GLOBAL CSV</button>
        <span class="muted" id="scanStatus">Ready</span>
      </div>

      <div class="sep"></div>

      <h2>Quick result</h2>
      <div id="quickResult" class="note">Ch∆∞a c√≥ k·∫øt qu·∫£. B·∫•m ‚ÄúScan now‚Äù.</div>

      <div class="sep"></div>

      <h2>GLOBAL results (all users/chats)</h2>
      <div class="note">Hi·ªÉn th·ªã theo th·ªùi gian m·ªõi nh·∫•t. Filter risk + search ·ªü ph√≠a tr√™n.</div>
      <div style="margin-top:8px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Target</th>
              <th>Risk</th>
              <th>IP / Ports</th>
              <th>Findings</th>
              <th>Meta</th>
            </tr>
          </thead>
          <tbody id="globalTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>GLOBAL analytics</h2>

      <div class="kpi">
        <div class="k"><div class="n" id="kTotal">‚Äî</div><div class="t">Total scans</div></div>
        <div class="k"><div class="n dangerText" id="kCritical">‚Äî</div><div class="t">CRITICAL</div></div>
        <div class="k"><div class="n" id="kHigh">‚Äî</div><div class="t">HIGH</div></div>
        <div class="k"><div class="n" id="kMed">‚Äî</div><div class="t">MEDIUM</div></div>
      </div>

      <div class="sep"></div>

      <h2>Bulk (SaaS API)</h2>
      <label>Targets (m·ªói d√≤ng 1 target ho·∫∑c ph√¢n t√°ch d·∫•u ph·∫©y)</label>
      <textarea id="bulkTextarea" placeholder="a.com&#10;b.com&#10;1.2.3.4"></textarea>

      <div class="toolbar" style="margin-top:10px">
        <button class="btn primary" id="bulkStartBtn">üöÄ Start bulk</button>
        <button class="btn" id="bulkPollBtn">‚è± Check status</button>
        <button class="btn small" id="bulkExportBtn">‚¨áÔ∏è Export batch CSV</button>
        <span class="muted" id="bulkStatus">No batch</span>
      </div>

      <div class="sep"></div>

      <h2>GLOBAL activity (latest)</h2>
      <div class="list" id="activityList"></div>

      <div class="sep"></div>

      <h2>Config (fixed)</h2>
      <div class="note mono" id="cfgBox"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/** =======================
 *  FIX THESE TWO CONSTANTS
 *  ======================= */
const FIXED_WORKER_URL = "https://YOUR-WORKER.workers.dev"; // <-- change
const DASHBOARD_TOKEN  = "YOUR_DASHBOARD_TOKEN";            // <-- change

/** UI State */
let currentRiskFilter = "ALL";
let globalCache = [];
let currentBatchId = localStorage.getItem("leakradar_batchId") || "";
let bulkPollTimer = null;

const $ = (id)=>document.getElementById(id);

init();

async function init(){
  $("cfgBox").textContent =
`WORKER: ${FIXED_WORKER_URL}
AUTH : Bearer ${mask(DASHBOARD_TOKEN)}
API  : /api/scan /api/bulk /api/global/*`;

  bindEvents();
  renderRecentChips();
  await healthCheck();
  await refreshGlobalAll();
  if(currentBatchId) {
    toast("Restored batchId: " + currentBatchId);
    await bulkStatusOnce();
  }
}

function bindEvents(){
  $("scanBtn").onclick = runScan;
  $("refreshGlobalBtn").onclick = refreshGlobalAll;
  $("exportGlobalBtn").onclick = exportGlobalCSV;

  $("bulkStartBtn").onclick = startBulk;
  $("bulkPollBtn").onclick = bulkStatusOnce;
  $("bulkExportBtn").onclick = exportBatchCSV;

  $("searchInput").addEventListener("input", renderGlobalTable);

  // risk chips
  document.querySelectorAll(".chip[data-risk]").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      document.querySelectorAll(".chip[data-risk]").forEach(x=>x.classList.remove("active"));
      ch.classList.add("active");
      currentRiskFilter = ch.dataset.risk;
      renderGlobalTable();
    });
  });

  // enter to scan
  $("targetInput").addEventListener("keydown", (e)=>{
    if(e.key==="Enter") runScan();
  });
}

function authHeaders(){
  return {
    "content-type":"application/json",
    "authorization": `Bearer ${DASHBOARD_TOKEN}`
  };
}

async function healthCheck(){
  try{
    const r = await fetch(FIXED_WORKER_URL + "/api/health", { headers: authHeaders() });
    const j = await r.json().catch(()=>null);
    if(!r.ok || !j || !j.ok) throw new Error(j?.error || ("HTTP "+r.status));
    setHealth(true, "Connected");
  }catch(e){
    setHealth(false, "Disconnected");
  }
}

function setHealth(ok, text){
  $("healthText").textContent = text;
  $("healthDot").className = "dot " + (ok ? "ok" : "bad");
}

/** =======================
 *  Scan
 *  ======================= */
async function runScan(){
  const raw = $("targetInput").value.trim();
  if(!raw) return toast("Nh·∫≠p target tr∆∞·ªõc ƒë√£.");
  $("scanStatus").textContent = "Scanning...";
  $("quickResult").textContent = "‚è≥ Running scan...";

  saveRecent(raw);
  renderRecentChips();

  try{
    const r = await fetch(FIXED_WORKER_URL + "/api/scan", {
      method:"POST",
      headers: authHeaders(),
      body: JSON.stringify({ target: raw, actor: "dashboard" })
    });
    const j = await r.json().catch(()=>null);
    if(!r.ok || !j?.ok) throw new Error(j?.error || ("HTTP "+r.status));
    const res = j.result;
    $("scanStatus").textContent = j.cached ? "Done (cache)" : "Done";
    $("quickResult").innerHTML = renderQuick(res, j.cached);

    // refresh global feed to show immediately
    await refreshGlobalAll(true);
  }catch(e){
    $("scanStatus").textContent = "Error";
    $("quickResult").innerHTML = `<span class="dangerText">‚ùå ${escapeHtml(String(e.message||e))}</span>`;
  }
}

/** =======================
 *  Bulk
 *  ======================= */
function parseTargets(text){
  return text.split(/[\n,]+/).map(x=>x.trim()).filter(Boolean);
}

async function startBulk(){
  const text = $("bulkTextarea").value.trim();
  const targets = parseTargets(text);
  if(!targets.length) return toast("Ch∆∞a c√≥ targets trong bulk.");

  $("bulkStatus").textContent = "Starting...";
  clearInterval(bulkPollTimer);

  try{
    const r = await fetch(FIXED_WORKER_URL + "/api/bulk",{
      method:"POST",
      headers: authHeaders(),
      body: JSON.stringify({ targets, actor:"dashboard" })
    });
    const j = await r.json().catch(()=>null);
    if(!r.ok || !j?.ok) throw new Error(j?.error || ("HTTP "+r.status));

    currentBatchId = j.batchId;
    localStorage.setItem("leakradar_batchId", currentBatchId);
    toast("Bulk started. batchId=" + currentBatchId);
    $("bulkStatus").textContent = `batchId=${currentBatchId} total=${j.total}`;

    // auto poll every 2.5s
    bulkPollTimer = setInterval(bulkStatusOnce, 2500);
  }catch(e){
    $("bulkStatus").textContent = "Error";
    toast("Bulk error: " + String(e.message||e));
  }
}

async function bulkStatusOnce(){
  if(!currentBatchId){
    $("bulkStatus").textContent = "No batch";
    return;
  }
  try{
    const r = await fetch(FIXED_WORKER_URL + `/api/bulk/status?batchId=${encodeURIComponent(currentBatchId)}`, {
      headers: authHeaders()
    });
    const j = await r.json().catch(()=>null);
    if(!r.ok || !j?.ok) throw new Error(j?.error || ("HTTP "+r.status));

    const p = j.progress;
    const remaining = j.remaining ?? 0;
    if(!p){
      $("bulkStatus").textContent = "No progress";
      return;
    }
    $("bulkStatus").textContent = `Progress ${p.done}/${p.total} (remaining ${remaining})`;

    // when done, stop polling and refresh global
    if(p.done >= p.total && remaining === 0){
      clearInterval(bulkPollTimer);
      bulkPollTimer = null;
      toast("Bulk done. Refreshing GLOBAL...");
      await refreshGlobalAll(true);
    }
  }catch(e){
    $("bulkStatus").textContent = "Error";
  }
}

function exportBatchCSV(){
  if(!currentBatchId) return toast("Ch∆∞a c√≥ batchId.");
  const url = FIXED_WORKER_URL + `/api/bulk/export.csv?batchId=${encodeURIComponent(currentBatchId)}`;
  downloadViaFetch(url, `leakradar_batch_${currentBatchId}.csv`);
}

/** =======================
 *  GLOBAL refresh + render
 *  ======================= */
async function refreshGlobalAll(silent=false){
  if(!silent) toast("Refreshing GLOBAL...");
  try{
    const [stats, act, results] = await Promise.all([
      apiGET("/api/global/stats"),
      apiGET("/api/global/activity?limit=120"),
      apiGET("/api/global/results?limit=250"),
    ]);

    if(stats?.stats) renderStats(stats.stats);
    renderActivity(act?.activity || []);
    globalCache = results?.results || [];
    renderGlobalTable();

    if(!silent) toast("Updated.");
  }catch(e){
    if(!silent) toast("Refresh error: " + String(e.message||e));
  }
}

function renderStats(s){
  $("kTotal").textContent = s.totalScans ?? "‚Äî";
  $("kCritical").textContent = s.riskCount?.CRITICAL ?? "‚Äî";
  $("kHigh").textContent = s.riskCount?.HIGH ?? "‚Äî";
  $("kMed").textContent = s.riskCount?.MEDIUM ?? "‚Äî";
}

function renderActivity(arr){
  const box = $("activityList");
  box.innerHTML = "";
  if(!arr.length){
    box.innerHTML = `<div class="note">Ch∆∞a c√≥ activity.</div>`;
    return;
  }
  for(const e of arr.slice(0,50)){
    const when = tsToTime(e.ts);
    const line = (e.type==="cmd")
      ? `üß† <b>${escapeHtml(e.cmd||"cmd")}</b> ${escapeHtml(e.target||"")} <span class="muted">(${escapeHtml(e.user||"")})</span>`
      : `üìå <b>${escapeHtml(e.domain||"")}</b> ‚Üí ${badgeHtml(e.risk)} <span class="muted">(${escapeHtml(e.user||"")})</span>`;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="top">
        <div class="title">${when}</div>
        <div class="meta mono">${escapeHtml(e.chat||"")}</div>
      </div>
      <div class="meta">${line}</div>
    `;
    box.appendChild(div);
  }
}

function renderGlobalTable(){
  const tb = $("globalTbody");
  tb.innerHTML = "";

  const q = $("searchInput").value.trim().toLowerCase();
  const filtered = (globalCache||[]).filter(r=>{
    if(currentRiskFilter !== "ALL" && r.risk !== currentRiskFilter) return false;
    if(!q) return true;
    const blob = JSON.stringify({
      domain:r.domain,
      ip:r.resolvedIp,
      risk:r.risk,
      shodan:r.shodan,
      leaks:r.leaks,
      sensitive:r.sensitivePaths,
      meta:r.meta
    }).toLowerCase();
    return blob.includes(q);
  });

  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="6" class="muted">No results (after filter).</td></tr>`;
    return;
  }

  for(const r of filtered.slice(0,250)){
    const time = tsToTime(r.ts || r.meta?.at);
    const ports = (r.shodan?.ports||[]).slice(0,18).join(", ");
    const ip = r.resolvedIp ? `<div class="mono">${escapeHtml(r.resolvedIp)}</div>` : `<div class="muted">‚Äî</div>`;
    const portHtml = ports ? `<div class="mono muted">${escapeHtml(ports)}</div>` : `<div class="muted">‚Äî</div>`;

    const leaks = (r.leaks||[]).slice(0,4).map(f=>`<div class="mono">‚Ä¢ ${escapeHtml(f.sev)} ${escapeHtml(f.path)}</div>`).join("");
    const sens = (r.sensitivePaths||[]).slice(0,3).map(s=>`<div class="mono muted">‚Ä¢ ${escapeHtml(s.path)} (${s.status})</div>`).join("");
    const findings = leaks || sens || `<div class="muted">‚Äî</div>`;

    const meta = r.meta || {};
    const metaHtml = `
      <div class="mono muted">src=${escapeHtml(meta.source||"")}</div>
      <div class="mono muted">${escapeHtml(meta.user||"")}</div>
      <div class="mono muted">${escapeHtml(meta.chat||"")}</div>
    `;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(time)}</td>
      <td>
        <div class="title mono">${escapeHtml(r.domain||"")}</div>
        ${r.shodan?.org ? `<div class="muted mono">${escapeHtml(r.shodan.org)}</div>` : `<div class="muted">‚Äî</div>`}
      </td>
      <td>${badgeHtml(r.risk)}</td>
      <td>${ip}${portHtml}</td>
      <td>${findings}</td>
      <td>${metaHtml}</td>
    `;
    tb.appendChild(tr);
  }
}

function renderQuick(r, cached){
  const ports = (r.shodan?.ports||[]).join(", ");
  const leaks = (r.leaks||[]).map(f=>`<div class="mono">‚Ä¢ <b>${escapeHtml(f.sev)}</b> ${escapeHtml(f.path)} (HTTP ${escapeHtml(f.status||"")})</div>`).join("");
  const sens  = (r.sensitivePaths||[]).map(s=>`<div class="mono muted">‚Ä¢ ${escapeHtml(s.path)} (${escapeHtml(s.status)})</div>`).join("");
  return `
    <div class="item">
      <div class="top">
        <div class="title mono">${escapeHtml(r.domain||"")}</div>
        <div class="right">${badgeHtml(r.risk)} <span class="muted" style="margin-left:10px">${cached?"cache":""}</span></div>
      </div>
      <div class="meta">
        <div class="mono muted">IP: ${escapeHtml(r.resolvedIp||"‚Äî")}</div>
        <div class="mono muted">Ports: ${escapeHtml(ports||"‚Äî")}</div>
        ${r.shodan?.org ? `<div class="mono muted">Org: ${escapeHtml(r.shodan.org)}</div>` : ""}
        ${r.shodan?.asn ? `<div class="mono muted">ASN: ${escapeHtml(r.shodan.asn)}</div>` : ""}
      </div>
      <div class="sep"></div>
      <div class="meta">
        <div style="font-weight:800;margin-bottom:6px">Findings</div>
        ${leaks || ""}
        ${sens || ""}
        ${(!leaks && !sens) ? `<div class="muted">No findings in MVP probes.</div>` : ""}
      </div>
    </div>
  `;
}

/** =======================
 *  CSV exports
 *  ======================= */
function exportGlobalCSV(){
  const url = FIXED_WORKER_URL + `/api/global/export.csv`;
  downloadViaFetch(url, `leakradar_global.csv`);
}

async function downloadViaFetch(url, filename){
  try{
    const r = await fetch(url, { headers: { "authorization": `Bearer ${DASHBOARD_TOKEN}` } });
    if(!r.ok) throw new Error("HTTP " + r.status);
    const blob = await r.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 800);
    toast("Downloading: " + filename);
  }catch(e){
    toast("Download error: " + String(e.message||e));
  }
}

/** =======================
 *  API helpers
 *  ======================= */
async function apiGET(path){
  const r = await fetch(FIXED_WORKER_URL + path, { headers: { "authorization": `Bearer ${DASHBOARD_TOKEN}` } });
  const j = await r.json().catch(()=>null);
  if(!r.ok || !j?.ok) throw new Error(j?.error || ("HTTP "+r.status));
  return j;
}

/** =======================
 *  Recent targets
 *  ======================= */
function getRecent(){
  try{
    return JSON.parse(localStorage.getItem("leakradar_recent")||"[]");
  }catch{ return []; }
}
function saveRecent(t){
  const arr = getRecent().filter(x=>x!==t);
  arr.unshift(t);
  if(arr.length>12) arr.length=12;
  localStorage.setItem("leakradar_recent", JSON.stringify(arr));
}
function renderRecentChips(){
  const box = $("recentChips");
  const arr = getRecent();
  box.innerHTML = "";
  if(!arr.length){
    box.innerHTML = `<span class="muted">‚Äî</span>`;
    return;
  }
  for(const t of arr){
    const el = document.createElement("span");
    el.className = "chip";
    el.textContent = t;
    el.onclick = ()=>{ $("targetInput").value = t; runScan(); };
    box.appendChild(el);
  }
}

/** =======================
 *  Utils
 *  ======================= */
function badgeHtml(risk){
  const cls = risk==="CRITICAL"?"b-crit":risk==="HIGH"?"b-high":risk==="MEDIUM"?"b-med":"b-ok";
  return `<span class="badge ${cls}">${escapeHtml(risk||"OK")}</span>`;
}
function tsToTime(ts){
  if(!ts) return "‚Äî";
  try{
    const d = new Date(ts);
    const pad=(n)=>String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}`;
  }catch{ return "‚Äî"; }
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(t._tm);
  t._tm = setTimeout(()=>t.style.display="none", 2200);
}
function mask(s){
  const v=String(s||"");
  if(v.length<=6) return "******";
  return v.slice(0,3) + "‚Ä¶" + v.slice(-3);
}
</script>
</body>
</html>
