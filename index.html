<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeakRadar ‚Äî Quick Scan</title>
  <style>
    :root{
      --bg:#070a14;--card:rgba(255,255,255,.06);--card2:rgba(255,255,255,.035);
      --line:rgba(255,255,255,.10);--txt:rgba(255,255,255,.92);--muted:rgba(255,255,255,.64);
      --shadow:0 20px 60px rgba(0,0,0,.45);--r:18px
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 70% -10%, rgba(0,255,255,.12), transparent 60%),
        radial-gradient(900px 700px at -10% 20%, rgba(255,0,255,.10), transparent 60%),
        radial-gradient(900px 700px at 60% 120%, rgba(0,255,120,.08), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 28px}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:10px;align-items:center;padding:12px 14px;border:1px solid var(--line);border-radius:999px;background:var(--card);box-shadow:var(--shadow)}
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg, rgba(0,255,255,1), rgba(255,0,255,1));box-shadow:0 0 18px rgba(0,255,255,.35)}
    .brand h1{font-size:14px;margin:0;letter-spacing:.6px}
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .grid{display:grid;grid-template-columns:1.35fr .65fr;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);background:linear-gradient(180deg, var(--card), var(--card2));border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .card h2{font-size:13px;margin:0 0 10px 0;color:rgba(255,255,255,.86);letter-spacing:.4px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{
      width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);color:var(--txt);padding:11px 12px;outline:none
    }
    textarea{min-height:120px;resize:vertical}
    button{
      cursor:pointer;background:linear-gradient(135deg, rgba(0,255,255,.16), rgba(255,0,255,.14));
      border:1px solid rgba(255,255,255,.20);font-weight:800
    }
    button:hover{filter:brightness(1.07)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btns button{flex:1 1 160px}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
    @media(max-width:760px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
    .kpi b{display:block;font-size:16px}.kpi span{display:block;color:var(--muted);font-size:12px;margin-top:4px}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;margin-top:10px;border:1px solid rgba(255,255,255,.12)}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(0,255,255,.85), rgba(255,0,255,.75))}
    .table{margin-top:12px;border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
    .thead,.trow{display:grid;grid-template-columns:1.2fr .9fr .65fr 1.35fr 1fr .7fr;gap:10px;align-items:center;padding:10px 12px}
    .thead{background:rgba(255,255,255,.06);color:rgba(255,255,255,.72);font-size:12px}
    .trow{border-top:1px solid rgba(255,255,255,.10);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:12px;font-weight:900;letter-spacing:.2px}
    .crit{background:rgba(255,0,80,.14)}.high{background:rgba(255,160,0,.14)}.med{background:rgba(255,255,255,.10)}.ok{background:rgba(0,255,160,.10)}
    .muted{color:var(--muted)}
    .click{cursor:pointer}
    .details{margin-top:10px;border-top:1px dashed rgba(255,255,255,.14);padding-top:10px;color:rgba(255,255,255,.80);font-size:13px;line-height:1.45;white-space:pre-wrap;display:none}
    .toast{position:fixed;left:12px;right:12px;bottom:14px;max-width:1200px;margin:0 auto;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.45);display:none}
    .hint{font-size:12px;color:var(--muted);line-height:1.6;margin:0}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .split > div{flex:1 1 240px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>LeakRadar ‚Äî Quick Scan</h1>
          <small>Internal mode ‚Ä¢ Domain/IP scan ‚Ä¢ Results + Export CSV</small>
        </div>
      </div>
      <div class="muted" id="clock"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Qu√©t nhanh</h2>

        <div class="split">
          <div>
            <label>Nh·∫≠p IP / Domain (m·ªói d√≤ng 1 target)</label>
            <textarea id="targets" placeholder="27.69.212.72&#10;example.com"></textarea>
            <div class="btns">
              <button id="btnScan">üöÄ Scan ngay</button>
              <button id="btnRefresh">üîÑ Refresh k·∫øt qu·∫£</button>
            </div>
          </div>

          <div>
            <label>Access Code (n·ªôi b·ªô)</label>
            <input id="access" type="password" placeholder="Nh·∫≠p m√£ truy c·∫≠p" />
            <label style="margin-top:10px">L·ªçc Risk</label>
            <select id="riskFilter">
              <option value="ALL">T·∫•t c·∫£</option>
              <option value="CRITICAL">CRITICAL</option>
              <option value="HIGH">HIGH</option>
              <option value="MEDIUM">MEDIUM</option>
              <option value="OK">OK</option>
            </select>
            <div class="btns">
              <button id="btnExport">‚¨áÔ∏è Export CSV</button>
            </div>

            <p class="hint">
              ‚Ä¢ ·∫®n to√†n b·ªô config (Worker URL / Token / ChatID).<br>
              ‚Ä¢ C√≥ allowlist ƒë·ªÉ tr√°nh l·∫°m d·ª•ng.<br>
              ‚Ä¢ N·∫øu mu·ªën public th·∫≠t s·ª±: n√™n th√™m ki·ªÉm so√°t ·ªü Worker (rate limit + auth server-side).
            </p>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi"><b id="kTotal">‚Äî</b><span>Total</span></div>
          <div class="kpi"><b id="kDone">‚Äî</b><span>Done</span></div>
          <div class="kpi"><b id="kRemaining">‚Äî</b><span>Remaining</span></div>
          <div class="kpi"><b id="kCritical">‚Äî</b><span>Critical</span></div>
          <div class="kpi"><b id="kUniqueIp">‚Äî</b><span>Unique IPs</span></div>
        </div>
        <div class="bar"><i id="bar"></i></div>

        <div class="table">
          <div class="thead"><div>Domain</div><div>IP</div><div>Risk</div><div>Ports</div><div>Leaks</div><div>Time</div></div>
          <div id="rows"></div>
        </div>

        <div class="details" id="details"></div>
      </div>

      <div class="card">
        <h2>Tr·∫°ng th√°i</h2>
        <p class="hint" id="statusText">Ch∆∞a c√≥ thao t√°c.</p>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,.12);margin:14px 0">
        <p class="hint">
          G·ª£i √Ω v·∫≠n h√†nh:<br>
          ‚Ä¢ Team n·ªôi b·ªô d√πng chung 1 dashboard + 1 access code.<br>
          ‚Ä¢ K·∫øt qu·∫£ l∆∞u KV theo chatId, refresh l√† th·∫•y.<br>
          ‚Ä¢ N·∫øu b·∫°n mu·ªën multi-tenant (m·ªói kh√°ch 1 workspace), m√¨nh c√≥ th·ªÉ thi·∫øt k·∫ø l·∫°i KV keys theo tenantId.
        </p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** =========================
 *  FIXED CONFIG (ADMIN SET)
 *  =========================
 *  Thay 4 gi√° tr·ªã d∆∞·ªõi ƒë√¢y r·ªìi upload dashboard l√† ch·∫°y.
 */
const FIXED_WORKER_URL = "https://leakradar.starlinksatellitewifi.workers.dev";
const FIXED_CHAT_ID    = "-1002345678901";
const FIXED_TOKEN      = "dash_9k23jf8sk29dk";

/**
 * Access code n·ªôi b·ªô (client-side gate).
 * L∆∞u √Ω: gate n√†y ch·ªâ n·∫±m tr√™n dashboard. Mu·ªën ch·∫∑n ch·∫Øc ch·∫Øn, n√™n check access code t·∫°i Worker.
 */
const ACCESS_CODE = "run_82kdk29skd";

/**
 * Allowlist: gi·∫£m r·ªßi ro b·ªã l·∫°m d·ª•ng.
 * - DOMAIN_SUFFIX: ch·ªâ cho ph√©p scan domain k·∫øt th√∫c b·∫±ng c√°c suffix n√†y.
 * - IP_CIDR: ch·ªâ cho ph√©p scan c√°c IP thu·ªôc CIDR b·∫°n qu·∫£n l√Ω.
 *
 * N·∫øu b·∫°n mu·ªën "kh√¥ng gi·ªõi h·∫°n" cho n·ªôi b·ªô, b·∫°n c√≥ th·ªÉ ƒë·ªÉ [] (r·ªóng),
 * nh∆∞ng KH√îNG n√™n public dashboard.
 */
const DOMAIN_SUFFIX_ALLOWLIST = [
  // ".yourcompany.com",
  // ".yourcustomer.vn"
];
const IP_CIDR_ALLOWLIST = [
  // "27.69.0.0/16",
  // "203.0.113.0/24"
];

// ========= UI utils =========
const $ = (id)=>document.getElementById(id);
setInterval(()=>{ $("clock").textContent = new Date().toLocaleString("vi-VN"); }, 800);

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__t);
  window.__t=setTimeout(()=>t.style.display="none", 2600);
}
function setStatus(msg){ $("statusText").textContent = msg; }

function pill(risk){
  const cls = risk==="CRITICAL"?"crit":risk==="HIGH"?"high":risk==="MEDIUM"?"med":"ok";
  return `<span class="pill ${cls}">${risk}</span>`;
}
function fmtTime(ts){
  if(!ts) return "‚Äî";
  return new Date(ts).toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
                  .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function summarizeLeaks(leaks){
  if(!leaks || !leaks.length) return `<span class="muted">‚Äî</span>`;
  const top = leaks.slice(0,3).map(f=>`${f.sev}:${f.path}`).join(" ‚Ä¢ ");
  const more = leaks.length>3 ? ` +${leaks.length-3}` : "";
  return escapeHtml(top + more);
}
function summarizePorts(sh){
  const ports = sh?.ports || [];
  if(!ports.length) return `<span class="muted">‚Äî</span>`;
  return escapeHtml(ports.slice(0,18).join(", ") + (ports.length>18 ? "‚Ä¶" : ""));
}
function applyFilter(results){
  const f = $("riskFilter").value;
  if(f==="ALL") return results;
  return results.filter(x=>x.risk===f);
}
function computeUniqueIps(results){
  const s = new Set();
  for(const r of results){ if(r.resolvedIp) s.add(r.resolvedIp); }
  return s.size;
}

// ========= Auth & API =========
function authHeader(){
  return { "Authorization": "Bearer " + FIXED_TOKEN };
}
function apiBase(){
  return FIXED_WORKER_URL.replace(/\/+$/,"");
}
function okAccess(){
  return ($("access").value || "").trim() === ACCESS_CODE;
}
async function getJSON(path){
  const r = await fetch(apiBase()+path, { headers: { ...authHeader() } });
  const j = await r.json().catch(()=>({ok:false,error:"bad json"}));
  if(!r.ok) throw new Error(j.error || ("HTTP "+r.status));
  return j;
}

// ========= Allowlist checks =========
function isIPv4(s){
  return /^(\d{1,3}\.){3}\d{1,3}$/.test(s) && s.split(".").every(n => +n >= 0 && +n <= 255);
}
function parseTargets(text){
  return text.split(/[\n,]+/).map(x=>x.trim()).filter(Boolean);
}
function domainAllowed(host){
  if(!DOMAIN_SUFFIX_ALLOWLIST.length) return true;
  const h = host.toLowerCase();
  return DOMAIN_SUFFIX_ALLOWLIST.some(suf => h.endsWith(suf.toLowerCase()));
}
function ipToInt(ip){
  return ip.split(".").reduce((acc,oct)=> (acc<<8) + (+oct), 0) >>> 0;
}
function cidrAllowed(ip){
  if(!IP_CIDR_ALLOWLIST.length) return true;
  const x = ipToInt(ip);
  for(const cidr of IP_CIDR_ALLOWLIST){
    const [net, bitsStr] = cidr.split("/");
    const bits = parseInt(bitsStr,10);
    if(!isIPv4(net) || isNaN(bits) || bits<0 || bits>32) continue;
    const mask = bits===0 ? 0 : (0xFFFFFFFF << (32-bits)) >>> 0;
    const n = ipToInt(net);
    if((x & mask) === (n & mask)) return true;
  }
  return false;
}
function targetAllowed(t){
  // treat as host (ip or domain)
  if(isIPv4(t)) return cidrAllowed(t);
  // if user paste url, strip scheme
  let host = t;
  try{
    if(!/^https?:\/\//i.test(host)) host = "https://" + host;
    host = new URL(host).hostname;
  }catch{}
  return domainAllowed(host);
}

// ========= Render =========
function showDetails(r){
  const d=$("details");
  const lines=[];
  lines.push(`üéØ Domain: ${r.domain||"‚Äî"}`);
  lines.push(`üìç IP: ${r.resolvedIp||"‚Äî"}`);
  lines.push(`‚ö†Ô∏è Risk: ${r.risk||"OK"}`);
  lines.push("");

  if(r.shodan){
    lines.push("üõ∞ Shodan intel:");
    if(r.shodan.org) lines.push(`‚Ä¢ Org: ${r.shodan.org}`);
    if(r.shodan.asn) lines.push(`‚Ä¢ ASN: ${r.shodan.asn}`);
    if(r.shodan.country) lines.push(`‚Ä¢ Country: ${r.shodan.country}`);
    if(r.shodan.ports?.length) lines.push(`‚Ä¢ Ports: ${r.shodan.ports.join(", ")}`);
    if(r.shodan.tags?.length) lines.push(`‚Ä¢ Tags: ${r.shodan.tags.join(", ")}`);
    if(r.shodan.vulns?.length) lines.push(`‚Ä¢ Vulns: ${r.shodan.vulns.slice(0,20).join(", ")}${r.shodan.vulns.length>20?"‚Ä¶":""}`);
    if(r.shodan.bannersTop?.length){
      lines.push(""); lines.push("Top services:");
      r.shodan.bannersTop.forEach(b=>{
        const p = b.product ? `${b.product}${b.version ? " "+b.version : ""}` : (b.http?.server || "service");
        lines.push(`‚Ä¢ ${b.port}/${b.transport||"tcp"} ‚Äî ${p}`);
        if(b.http?.title) lines.push(`  ‚Ü≥ title: ${b.http.title}`);
      });
    }
    if(r.shodan.error){ lines.push(""); lines.push(`‚ÑπÔ∏è Shodan note: ${r.shodan.error}`); }
    lines.push("");
  }

  if(r.sensitivePaths && r.sensitivePaths.length){
    lines.push("üß© Sensitive endpoints (defensive):");
    r.sensitivePaths.slice(0,10).forEach(s=>{
      lines.push(`‚Ä¢ ${s.path} (HTTP ${s.status})`);
      if(s.url) lines.push(`  ‚Ü≥ ${s.url}`);
    });
    if(r.sensitivePaths.length>10) lines.push(`‚Ä¶ v√† ${r.sensitivePaths.length-10} m·ª•c kh√°c.`);
    lines.push("");
  }

  if(!r.leaks || !r.leaks.length){
    lines.push("‚úÖ Kh√¥ng ph√°t hi·ªán leak paths (bot ch·ªâ probe khi c√≥ web ports).");
  } else {
    lines.push("üîì Leak findings:");
    r.leaks.forEach(f=>{
      lines.push(`‚Ä¢ [${f.sev}] ${f.path} (HTTP ${f.status})`);
      if(f.url) lines.push(`  ‚Ü≥ ${f.url}`);
      if(f.evidence) lines.push(`  ‚Ü≥ evidence: ${String(f.evidence).replace(/\s+/g," ").trim()}`);
    });
  }

  lines.push(""); lines.push("‚úÖ Fix nhanh:");
  lines.push("1) Block /.env v√† /.git/* (Nginx/Apache/WAF)");
  lines.push("2) Rotate secrets n·∫øu nghi l·ªô");
  lines.push("3) T·∫Øt swagger/openapi public n·∫øu kh√¥ng c·∫ßn");

  d.style.display="block";
  d.textContent=lines.join("\n");
  window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
}

function renderTable(results){
  const rows = $("rows");
  rows.innerHTML = "";
  const filtered = applyFilter(results);
  filtered.sort((a,b)=> (b.ts||0)-(a.ts||0)).forEach(r=>{
    const el = document.createElement("div");
    el.className="trow click";
    el.innerHTML = `
      <div>${escapeHtml(r.domain||"‚Äî")}</div>
      <div class="muted">${escapeHtml(r.resolvedIp||"‚Äî")}</div>
      <div>${pill(r.risk||"OK")}</div>
      <div>${summarizePorts(r.shodan)}</div>
      <div>${summarizeLeaks(r.leaks)}</div>
      <div class="muted">${fmtTime(r.ts)}</div>`;
    el.addEventListener("click", ()=> showDetails(r));
    rows.appendChild(el);
  });
  if(!filtered.length){
    const el=document.createElement("div");
    el.className="trow";
    el.innerHTML=`<div class="muted" style="grid-column:1/-1">Kh√¥ng c√≥ d·ªØ li·ªáu theo filter.</div>`;
    rows.appendChild(el);
  }
}

async function refresh(){
  try{
    setStatus("ƒêang refresh d·ªØ li·ªáu‚Ä¶");
    const cid = encodeURIComponent(FIXED_CHAT_ID);
    const st = await getJSON(`/api/bulk/status?chatId=${cid}`);
    const rs = await getJSON(`/api/bulk/results?chatId=${cid}`);

    const total = st.progress?.total ?? (rs.results?.length ?? 0);
    const done  = st.progress?.done  ?? (rs.results?.length ?? 0);
    const remaining = st.remaining ?? 0;

    $("kTotal").textContent = total ?? "‚Äî";
    $("kDone").textContent = done ?? "‚Äî";
    $("kRemaining").textContent = remaining ?? "‚Äî";
    $("kCritical").textContent = (rs.results||[]).filter(x=>x.risk==="CRITICAL").length;
    $("kUniqueIp").textContent = computeUniqueIps(rs.results||[]);

    const pct = total ? Math.min(100, Math.round((done/total)*100)) : 0;
    $("bar").style.width = pct + "%";

    renderTable(rs.results||[]);
    toast("ƒê√£ refresh.");
    setStatus(`OK ‚Ä¢ ${done}/${total} done ‚Ä¢ remaining ${remaining}`);
  }catch(e){
    toast("L·ªói: " + (e.message||e));
    setStatus("L·ªói refresh: " + (e.message||e));
  }
}

async function exportCSV(){
  try{
    if(!okAccess()) return toast("Sai Access Code.");
    const cid = encodeURIComponent(FIXED_CHAT_ID);
    const href = apiBase() + `/api/bulk/export.csv?chatId=${cid}`;
    const r = await fetch(href, { headers: { ...authHeader() } });
    if(!r.ok) throw new Error("Export l·ªói HTTP " + r.status);
    const blob = await r.blob();
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `leakradar_${Date.now()}.csv`;
    a.click();
    toast("ƒê√£ t·∫£i CSV.");
  }catch(e){
    toast("L·ªói export: " + (e.message||e));
  }
}

// ========= Scan trigger =========
// L∆∞u √Ω: Worker hi·ªán t·∫°i ch·∫°y scan qua Telegram webhook (/telegram).
// Dashboard s·∫Ω g·ª≠i m·ªôt ‚Äúupdate gi·∫£ l·∫≠p‚Äù v√†o /telegram ƒë·ªÉ k√≠ch ho·∫°t /bulk.
// C√°i n√†y d√πng n·ªôi b·ªô OK, nh∆∞ng n·∫øu public th√¨ n√™n chuy·ªÉn sang endpoint /api/scan c√≥ auth server-side.
async function triggerBulk(targets){
  const payload = {
    message: {
      chat: { id: FIXED_CHAT_ID },
      text: "/bulk\n" + targets.join("\n")
    }
  };
  await fetch(apiBase()+"/telegram",{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify(payload)
  });
}

async function runScan(){
  try{
    if(!okAccess()) return toast("Sai Access Code.");
    const list = parseTargets($("targets").value);
    if(!list.length) return toast("Nh·∫≠p IP/domain tr∆∞·ªõc.");

    // allowlist enforcement
    const denied = list.filter(t => !targetAllowed(t));
    if(denied.length){
      return toast("Target kh√¥ng thu·ªôc allowlist: " + denied.slice(0,3).join(", ") + (denied.length>3 ? "‚Ä¶" : ""));
    }

    setStatus("ƒê√£ g·ª≠i scan. ƒêang ch·∫°y batch‚Ä¶");
    toast("ƒê√£ g·ª≠i scan. ƒê·ª£i 5‚Äì15s r·ªìi Refresh.");

    // Trigger as /bulk to reuse worker flow
    await triggerBulk(list.slice(0,200));

  }catch(e){
    toast("L·ªói scan: " + (e.message||e));
  }
}

// ========= events =========
$("btnScan").addEventListener("click", runScan);
$("btnRefresh").addEventListener("click", refresh);
$("btnExport").addEventListener("click", exportCSV);

// Auto refresh every 12s
setInterval(()=>{ refresh().catch(()=>{}); }, 12000);
</script>
</body>
</html>
