    <!doctype html>
    <html lang="vi">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <title>LeakRadar ‚Äî Bulk Dashboard (Domain-first)</title>
      <style>
        :root{--bg:#070a14;--card:rgba(255,255,255,.06);--card2:rgba(255,255,255,.035);--line:rgba(255,255,255,.10);--txt:rgba(255,255,255,.92);--muted:rgba(255,255,255,.64);--shadow:0 20px 60px rgba(0,0,0,.45);--r:18px}
        *{box-sizing:border-box}
        body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--txt);
          background:radial-gradient(1200px 800px at 70% -10%, rgba(0,255,255,.12), transparent 60%),
                   radial-gradient(900px 700px at -10% 20%, rgba(255,0,255,.10), transparent 60%),
                   radial-gradient(900px 700px at 60% 120%, rgba(0,255,120,.08), transparent 60%), var(--bg);}
        .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 28px}
        .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:14px}
        .brand{display:flex;gap:10px;align-items:center;padding:12px 14px;border:1px solid var(--line);border-radius:999px;background:var(--card);box-shadow:var(--shadow)}
        .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg, rgba(0,255,255,1), rgba(255,0,255,1));box-shadow:0 0 18px rgba(0,255,255,.35)}
        .brand h1{font-size:14px;margin:0;letter-spacing:.6px}
        .brand small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
        .grid{display:grid;grid-template-columns:1.35fr .65fr;gap:12px}
        @media(max-width:980px){.grid{grid-template-columns:1fr}}
        .card{border:1px solid var(--line);background:linear-gradient(180deg, var(--card), var(--card2));border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
        .card h2{font-size:13px;margin:0 0 10px 0;color:rgba(255,255,255,.86);letter-spacing:.4px}
        .row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1 1 180px}
        label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
        input,select,button,textarea{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:var(--txt);padding:11px 12px;outline:none}
        textarea{min-height:120px;resize:vertical}
        button{cursor:pointer;background:linear-gradient(135deg, rgba(0,255,255,.16), rgba(255,0,255,.14));border:1px solid rgba(255,255,255,.20);font-weight:700}
        button:hover{filter:brightness(1.07)}
        .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}.btns button{flex:1 1 160px}
        .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}@media(max-width:760px){.kpis{grid-template-columns:repeat(2,1fr)}}
        .kpi{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
        .kpi b{display:block;font-size:16px}.kpi span{display:block;color:var(--muted);font-size:12px;margin-top:4px}
        .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;margin-top:10px;border:1px solid rgba(255,255,255,.12)}.bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(0,255,255,.85), rgba(255,0,255,.75))}
        .table{margin-top:12px;border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
        .thead,.trow{display:grid;grid-template-columns:1.2fr .9fr .65fr 1.35fr 1fr .7fr;gap:10px;align-items:center;padding:10px 12px}
        .thead{background:rgba(255,255,255,.06);color:rgba(255,255,255,.72);font-size:12px}
        .trow{border-top:1px solid rgba(255,255,255,.10);font-size:13px}
        .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:12px;font-weight:800;letter-spacing:.2px}
        .crit{background:rgba(255,0,80,.14)}.high{background:rgba(255,160,0,.14)}.med{background:rgba(255,255,255,.10)}.ok{background:rgba(0,255,160,.10)}
        .muted{color:var(--muted)}.click{cursor:pointer}
        .details{margin-top:10px;border-top:1px dashed rgba(255,255,255,.14);padding-top:10px;color:rgba(255,255,255,.80);font-size:13px;line-height:1.45;white-space:pre-wrap}
        .toast{position:fixed;left:12px;right:12px;bottom:14px;max-width:1200px;margin:0 auto;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.45);display:none}
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="top">
          <div class="brand"><div class="dot"></div><div><h1>LeakRadar ‚Äî Bulk Dashboard</h1><small>Domain-first ‚Ä¢ Shodan + leak paths ‚Ä¢ Export CSV</small></div></div>
          <div class="muted" id="clock"></div>
        </div>

        <div class="grid">
          <div class="card">
            <h2>K·∫øt n·ªëi</h2>
            <div class="row">
              <div><label>Worker URL</label><input id="workerUrl" placeholder="https://your-worker.workers.dev" /></div>
              <div><label>Chat ID (Telegram)</label><input id="chatId" placeholder="-100xxxxxxxxxx" /></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div><label>Dashboard Token</label><input id="token" placeholder="DASHBOARD_TOKEN" /></div>
              <div><label>L·ªçc Risk</label>
                <select id="riskFilter">
                  <option value="ALL">T·∫•t c·∫£</option><option value="CRITICAL">CRITICAL</option><option value="HIGH">HIGH</option><option value="MEDIUM">MEDIUM</option><option value="OK">OK</option>
                </select>
              </div>
            </div>
            <div class="btns"><button id="btnRefresh">üîÑ Refresh</button><button id="btnExport">‚¨áÔ∏è Export CSV</button></div>

            <div style="margin-top:12px" class="kpis">
              <div class="kpi"><b id="kTotal">‚Äî</b><span>Total</span></div>
              <div class="kpi"><b id="kDone">‚Äî</b><span>Done</span></div>
              <div class="kpi"><b id="kRemaining">‚Äî</b><span>Remaining</span></div>
              <div class="kpi"><b id="kCritical">‚Äî</b><span>Critical</span></div>
              <div class="kpi"><b id="kUniqueIp">‚Äî</b><span>Unique IPs</span></div>
            </div>
            <div class="bar"><i id="bar"></i></div>

            <div class="table">
              <div class="thead"><div>Domain</div><div>IP</div><div>Risk</div><div>Ports</div><div>Leaks</div><div>Time</div></div>
              <div id="rows"></div>
            </div>

            <div class="details" id="details" style="display:none"></div>
          </div>

          <div class="card">
            <h2>G·ª≠i batch (/bulk)</h2>
            <label>Danh s√°ch target (m·ªói d√≤ng 1 domain/IP)</label>
            <textarea id="bulkText" placeholder="example.com
api.example.com
1.2.3.4"></textarea>
            <div class="btns"><button id="btnCopyCmd">üìã Copy l·ªánh /bulk</button><button id="btnShareTG">üì® M·ªü Telegram share</button></div>
            <hr style="border:none;border-top:1px solid rgba(255,255,255,.12);margin:14px 0">
            <p class="muted" style="margin:0;line-height:1.6">
              ‚Ä¢ Click 1 d√≤ng ƒë·ªÉ xem chi ti·∫øt leak + Shodan evidence.<br>
              ‚Ä¢ Dashboard ch·ªâ ƒë·ªçc d·ªØ li·ªáu KV; scan ch·∫°y qua Telegram bot.
            </p>
          </div>
        </div>
      </div>

      <div class="toast" id="toast"></div>

      <script>
        const $ = (id)=>document.getElementById(id);
        setInterval(()=>{ $("clock").textContent = new Date().toLocaleString("vi-VN"); }, 800);

        const storeKeys = ["workerUrl","chatId","token","riskFilter"];
        storeKeys.forEach(k=>{
          const v = localStorage.getItem("lr:"+k);
          if(v && $(k)) $(k).value = v;
          if($(k)) $(k).addEventListener("input", ()=> localStorage.setItem("lr:"+k, $(k).value));
          if($(k)) $(k).addEventListener("change", ()=> localStorage.setItem("lr:"+k, $(k).value));
        });

        function toast(msg){
          const t=$("toast");
          t.textContent=msg;
          t.style.display="block";
          clearTimeout(window.__t);
          window.__t=setTimeout(()=>t.style.display="none", 2600);
        }

        function apiBase(){
          const base = ($("workerUrl").value||"").trim().replace(/\/+$/,"");
          if(!base) throw new Error("Thi·∫øu Worker URL");
          return base;
        }
        function authHeader(){
          const tok = ($("token").value||"").trim();
          if(!tok) throw new Error("Thi·∫øu Dashboard Token");
          return { "Authorization": "Bearer " + tok };
        }
        function chatId(){
          const c = ($("chatId").value||"").trim();
          if(!c) throw new Error("Thi·∫øu chatId");
          return c;
        }
        async function getJSON(path){
          const r = await fetch(apiBase()+path, { headers: { ...authHeader() } });
          const j = await r.json().catch(()=>({ok:false,error:"bad json"}));
          if(!r.ok) throw new Error(j.error || ("HTTP "+r.status));
          return j;
        }

        function escapeHtml(s){
          return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
        }
        function pill(risk){
          const cls = risk==="CRITICAL"?"crit":risk==="HIGH"?"high":risk==="MEDIUM"?"med":"ok";
          return `<span class="pill ${cls}">${risk}</span>`;
        }
        function fmtTime(ts){
          if(!ts) return "‚Äî";
          return new Date(ts).toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        }
        function summarizeLeaks(leaks){
          if(!leaks || !leaks.length) return `<span class="muted">‚Äî</span>`;
          const top = leaks.slice(0,3).map(f=>`${f.sev}:${f.path}`).join(" ‚Ä¢ ");
          const more = leaks.length>3 ? ` +${leaks.length-3}` : "";
          return escapeHtml(top + more);
        }
        function summarizePorts(sh){
          const ports = sh?.ports || [];
          if(!ports.length) return `<span class="muted">‚Äî</span>`;
          return escapeHtml(ports.slice(0,18).join(", ") + (ports.length>18 ? "‚Ä¶" : ""));
        }
        function applyFilter(results){
          const f = $("riskFilter").value;
          if(f==="ALL") return results;
          return results.filter(x=>x.risk===f);
        }
        function computeUniqueIps(results){
          const s = new Set();
          for(const r of results){ if(r.resolvedIp) s.add(r.resolvedIp); }
          return s.size;
        }

        function renderTable(results){
          const rows = $("rows");
          rows.innerHTML = "";
          const filtered = applyFilter(results);
          filtered.sort((a,b)=> (b.ts||0)-(a.ts||0)).forEach(r=>{
            const el = document.createElement("div");
            el.className="trow click";
            el.innerHTML = `
              <div>${escapeHtml(r.domain||"‚Äî")}</div>
              <div class="muted">${escapeHtml(r.resolvedIp||"‚Äî")}</div>
              <div>${pill(r.risk||"OK")}</div>
              <div>${summarizePorts(r.shodan)}</div>
              <div>${summarizeLeaks(r.leaks)}</div>
              <div class="muted">${fmtTime(r.ts)}</div>`;
            el.addEventListener("click", ()=> showDetails(r));
            rows.appendChild(el);
          });
          if(!filtered.length){
            const el=document.createElement("div");
            el.className="trow";
            el.innerHTML=`<div class="muted" style="grid-column:1/-1">Kh√¥ng c√≥ d·ªØ li·ªáu theo filter.</div>`;
            rows.appendChild(el);
          }
        }

        function showDetails(r){
          const d=$("details");
          const lines=[];
          lines.push(`üéØ Domain: ${r.domain||"‚Äî"}`);
          lines.push(`üìç IP: ${r.resolvedIp||"‚Äî"}`);
          lines.push(`‚ö†Ô∏è Risk: ${r.risk||"OK"}`);
          lines.push("");
          if(r.shodan){
            lines.push("üõ∞ Shodan intel:");
            if(r.shodan.org) lines.push(`‚Ä¢ Org: ${r.shodan.org}`);
            if(r.shodan.asn) lines.push(`‚Ä¢ ASN: ${r.shodan.asn}`);
            if(r.shodan.country) lines.push(`‚Ä¢ Country: ${r.shodan.country}`);
            if(r.shodan.ports?.length) lines.push(`‚Ä¢ Ports: ${r.shodan.ports.join(", ")}`);
            if(r.shodan.tags?.length) lines.push(`‚Ä¢ Tags: ${r.shodan.tags.join(", ")}`);
            if(r.shodan.vulns?.length) lines.push(`‚Ä¢ Vulns: ${r.shodan.vulns.slice(0,20).join(", ")}${r.shodan.vulns.length>20?"‚Ä¶":""}`);
            if(r.shodan.bannersTop?.length){
              lines.push(""); lines.push("Top services:");
              r.shodan.bannersTop.forEach(b=>{
                const p = b.product ? `${b.product}${b.version ? " "+b.version : ""}` : (b.http?.server || "service");
                lines.push(`‚Ä¢ ${b.port}/${b.transport||"tcp"} ‚Äî ${p}`);
                if(b.http?.title) lines.push(`  ‚Ü≥ title: ${b.http.title}`);
              });
            }
            if(r.shodan.error){ lines.push(""); lines.push(`‚ÑπÔ∏è Shodan note: ${r.shodan.error}`); }
            lines.push("");
          }
          if(r.sensitivePaths && r.sensitivePaths.length){
            lines.push("üß© Sensitive endpoints (defensive):");
            r.sensitivePaths.slice(0,10).forEach(s=>{ lines.push(`‚Ä¢ ${s.path} (HTTP ${s.status})`); if(s.url) lines.push(`  ‚Ü≥ ${s.url}`); });
            if(r.sensitivePaths.length>10) lines.push(`‚Ä¶ v√† ${r.sensitivePaths.length-10} m·ª•c kh√°c.`);
            lines.push("");
          }
          if(!r.leaks || !r.leaks.length){
            lines.push("‚úÖ Kh√¥ng ph√°t hi·ªán leak paths (bot ch·ªâ probe khi c√≥ web ports).");
          } else {
            lines.push("üîì Leak findings:");
            r.leaks.forEach(f=>{
              lines.push(`‚Ä¢ [${f.sev}] ${f.path} (HTTP ${f.status})`);
              if(f.url) lines.push(`  ‚Ü≥ ${f.url}`);
              if(f.evidence) lines.push(`  ‚Ü≥ evidence: ${String(f.evidence).replace(/\s+/g," ").trim()}`);
            });
          }
          lines.push(""); lines.push("‚úÖ Fix nhanh:");
          lines.push("1) Block /.env v√† /.git/* (Nginx/Apache/WAF)");
          lines.push("2) Rotate secrets n·∫øu nghi l·ªô");
          lines.push("3) T·∫Øt swagger/openapi public n·∫øu kh√¥ng c·∫ßn");
          d.style.display="block";
          d.textContent=lines.join("
");
          window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
        }

        async function refresh(){
          try{
            const cid=chatId();
            const st = await getJSON(`/api/bulk/status?chatId=${encodeURIComponent(cid)}`);
            const rs = await getJSON(`/api/bulk/results?chatId=${encodeURIComponent(cid)}`);
            const total = st.progress?.total ?? (rs.results?.length ?? 0);
            const done = st.progress?.done ?? (rs.results?.length ?? 0);
            const remaining = st.remaining ?? 0;
            $("kTotal").textContent = total ?? "‚Äî";
            $("kDone").textContent = done ?? "‚Äî";
            $("kRemaining").textContent = remaining ?? "‚Äî";
            $("kCritical").textContent = (rs.results||[]).filter(x=>x.risk==="CRITICAL").length;
            $("kUniqueIp").textContent = computeUniqueIps(rs.results||[]);
            const pct = total ? Math.min(100, Math.round((done/total)*100)) : 0;
            $("bar").style.width = pct + "%";
            renderTable(rs.results||[]);
            toast("ƒê√£ refresh d·ªØ li·ªáu.");
          }catch(e){ toast("L·ªói: " + (e.message||e)); }
        }

        $("btnRefresh").addEventListener("click", refresh);

        $("btnExport").addEventListener("click", async ()=>{
          try{
            const cid=chatId();
            const href = apiBase() + `/api/bulk/export.csv?chatId=${encodeURIComponent(cid)}`;
            const r = await fetch(href, { headers: { ...authHeader() } });
            if(!r.ok) throw new Error("Export l·ªói HTTP " + r.status);
            const blob = await r.blob();
            const a=document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `leakradar_domain_${cid}_${Date.now()}.csv`;
            a.click();
            toast("ƒê√£ t·∫£i CSV.");
          }catch(e){ toast("L·ªói export: " + (e.message||e)); }
        });

        function buildBulkCommand(){
          const lines = ($("bulkText").value||"").trim().split("
").map(x=>x.trim()).filter(Boolean);
          if(!lines.length) throw new Error("Ch∆∞a c√≥ target trong √¥ danh s√°ch.");
          return "/bulk
" + lines.slice(0,200).join("
");
        }

        $("btnCopyCmd").addEventListener("click", async ()=>{
          try{ const cmd=buildBulkCommand(); await navigator.clipboard.writeText(cmd); toast("ƒê√£ copy l·ªánh /bulk."); }
          catch(e){ toast("Kh√¥ng copy ƒë∆∞·ª£c: " + (e.message||e)); }
        });

        $("btnShareTG").addEventListener("click", ()=>{
          try{ const cmd=buildBulkCommand(); window.open("https://t.me/share/url?url=&text="+encodeURIComponent(cmd), "_blank"); }
          catch(e){ toast("L·ªói: " + (e.message||e)); }
        });

        setInterval(()=>{ refresh().catch(()=>{}); }, 12000);
      </script>
    </body>
    </html>
